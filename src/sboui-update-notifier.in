#!/usr/bin/env python

import sys
from time import sleep
import subprocess

def sbo_updates_available():

  proc = subprocess.Popen(['${CMAKE_INSTALL_PREFIX}/sbin/sboui', '-p'],
                          stdout=subprocess.PIPE)
  for line in iter(proc.stdout.readline,''):
    if line.find("upgradable SlackBuilds") != -1:
      if line.startswith("No"):
        return False
      else:
        return True

  return False

if __name__ == "__main__":

  # Sleep time in seconds

  if len(sys.argv) > 1:
    try:
      interval = int(sys.argv[1])
    except ValueError:
      interval = 3600
  else:
    interval = 3600

  # Set update command (kdesu requires -c argument, others like gksu and ktsuss
  # don't)

  update_cmd = '${CMAKE_INSTALL_PREFIX}/libexec/sboui/sboui_update_launch'
  graphical_su = "${GRAPHICAL_SU}"
  if graphical_su == "kdesu":
    cmd = [graphical_su, '-c',
           '${TERMINAL_EMULATOR} -e {}'.format(update_cmd)]
  else:
    cmd = [graphical_su,
           '${TERMINAL_EMULATOR} -e {}'.format(update_cmd)]

  # Main loop. Show systray icon if updates are available. Quit if requested.

  while True:

    if sbo_updates_available():
      retval = subprocess.call(['${CMAKE_INSTALL_PREFIX}' +
                                '/libexec/sboui/sboui-systray.py'])
      if retval == 0:
        subprocess.call(cmd)
      elif retval == 2:
        break

    sleep(interval)
